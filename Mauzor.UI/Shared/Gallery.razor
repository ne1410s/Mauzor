@using FullStack.Av.Domain
@using Mauzor.UI.Shared
@using System.IO
@using System.Diagnostics
@using Microsoft.Extensions.Logging
@using Microsoft.Maui.Essentials

@inject ILogger<Gallery> logger;

<div>
    <select title="view mode" @bind="viewMode">
        <option value="@GalleryViewMode.DetailList">Detail list</option>
        <option value="@GalleryViewMode.SmallIcons">Small icons</option>
        <option value="@GalleryViewMode.LargeIcons">Large icons</option>
    </select>
</div>

<div>
    <input type="button" title="up" @onclick="() => Navigate(currentDir.Parent!)" disabled="@(!CanGoUp)" value=".." />
    <input type="button" title="refresh" @onclick="ReloadCurrent" value="↻" />
    <input type="button" title="import" @onclick="ImportFiles" value="↦" />
    <span>@currentDir.FullName</span>
</div>

<div class="gallery @AuxClasses">
    <ListView @ref="listControl" T="FileSystemInfo" Items="items" Orientation="orientation" SelectionChanged="OnSelectionChanged">
        <ItemTemplate Context="item">
            <GalleryItem ViewMode="@viewMode" Info="item" OnDoubleClick="ItemDoubleClicked" />
        </ItemTemplate>
    </ListView>
</div>

<div>
    <input type="button" disabled="@(selectedFile == null)" value="file action" />
</div>

<FilePreview File="selectedFile"/>

@code {

    private GalleryViewMode viewMode = GalleryViewMode.DetailList;

    private DirectoryInfo currentDir = null!;
    private List<FileSystemInfo> items = new List<FileSystemInfo>();
    private ListView<FileSystemInfo> listControl = null!;
    private FileInfo? selectedFile;

    private bool CanGoUp => currentDir.Parent != null;

    private string AuxClasses => viewMode switch
    {
        GalleryViewMode.LargeIcons => "large",
        GalleryViewMode.DetailList => "small detail",
        _ => "small"
    };

    private ListOrientation orientation => viewMode switch
    {
        GalleryViewMode.DetailList => ListOrientation.Vertical,
        _ => ListOrientation.Horizontal,
    };

    protected override void OnInitialized()
    {
        base.OnInitialized();

        var specialFolder = Environment.SpecialFolder.MyDocuments;
        var specialPath = Environment.GetFolderPath(specialFolder);
        var specialDirInfo = new DirectoryInfo(specialPath);
        var appMediaFiles = specialDirInfo.CreateSubdirectory("mauzor");

        Navigate(appMediaFiles);
    }

    private void ReloadCurrent() => Navigate(currentDir);

    private async Task ImportFiles()
    {
        var file = await InteropExtensions.PickFile(true);
    }

    private void OnSelectionChanged(FileSystemInfo? info) => selectedFile = info as FileInfo;

    private void Navigate(DirectoryInfo dir)
    {
        currentDir = dir;
        listControl?.ClearSelection();
        items.Clear();

        var folderOptions = new EnumerationOptions { IgnoreInaccessible = true };
        items.AddRange(dir.GetDirectories("*", folderOptions));
        items.AddRange(dir.EnumerateMedia(recursive: false));
    }

    private void ItemDoubleClicked(FileSystemInfo info)
    {
        if (info is FileInfo fi)
        {
            
        }
        else if (info is DirectoryInfo di)
        {
            Navigate(di);
        }
    }
}
